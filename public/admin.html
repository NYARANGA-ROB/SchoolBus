<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; }
      header { padding: 12px 16px; display: flex; gap: 12px; align-items: center; border-bottom: 1px solid #ddd; }
      #map { height: calc(100vh - 56px); }
      input, button { padding: 8px 10px; }
      .pill { padding: 6px 10px; border: 1px solid #ddd; border-radius: 999px; font-size: 12px; }
    </style>
  </head>
  <body>
    <header>
      <strong>Admin</strong>
      <input id="email" placeholder="admin email" />
      <input id="password" placeholder="password" type="password" />
      <button id="login">Login</button>
      <span id="status" class="pill">Not connected</span>
    </header>
    <div id="map"></div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module">
      import { api, el } from './app.js';

      let token = null;
      let socket = null;

      const map = L.map('map').setView([0, 0], 2);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

      const markers = new Map();

      function setStatus(text) {
        el('status').textContent = text;
      }

      el('login').onclick = async () => {
        try {
          const email = el('email').value;
          const password = el('password').value;
          const res = await api('/auth/login', { method: 'POST', body: { email, password } });
          token = res.token;

          const overview = await api('/admin/overview', { token });
          setStatus(`Logged in. Buses: ${overview.buses.length}`);

          socket = io({ auth: { token } });
          socket.on('connect', () => setStatus('Socket connected'));
          socket.on('disconnect', () => setStatus('Socket disconnected'));
          socket.on('busLocation', (msg) => {
            const { busId, lat, lng } = msg;
            const key = busId;
            if (!markers.has(key)) {
              const m = L.marker([lat, lng]).addTo(map).bindPopup(`Bus ${busId}`);
              markers.set(key, m);
            } else {
              markers.get(key).setLatLng([lat, lng]);
            }
          });

          for (const b of overview.buses) {
            socket.emit('subscribeBus', b.id);
          }
        } catch (e) {
          setStatus(e.message);
        }
      };
    </script>
  </body>
</html>
